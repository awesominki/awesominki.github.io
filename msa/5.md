---
layout: page
title: 5. API ê²Œì´íŠ¸ì›¨ì´ (Spring Cloud Gateway)
description: >
hide_description: true
sitemap: false
---

## 5.1 API ê²Œì´íŠ¸ì›¨ì´ ê°œìš”

### 5.1.1 API ê²Œì´íŠ¸ì›¨ì´ë€?

- API ê²Œì´íŠ¸ì›¨ì´ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ë°›ì•„ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ê³ , ë‹¤ì–‘í•œ ë¶€ê°€ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì¤‘ê°„ ì„œë²„ì…ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë¹„ìŠ¤ ê°„ì˜ ë‹¨ì¼ ì§„ì…ì  ì—­í• ì„ í•˜ë©°, ë³´ì•ˆ, ë¡œê¹…, ëª¨ë‹ˆí„°ë§, ìš”ì²­ í•„í„°ë§ ë“±ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### 5.1.2 API ê²Œì´íŠ¸ì›¨ì´ì˜ ì£¼ìš” ê¸°ëŠ¥

- **ë¼ìš°íŒ…**: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì ì ˆí•œ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬
- **ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬**: ìš”ì²­ì˜ ì¸ì¦ ë° ê¶Œí•œì„ ê²€ì¦
- **ë¡œë“œ ë°¸ëŸ°ì‹±**: ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ê°„ì˜ ë¶€í•˜ ë¶„ì‚°
- **ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…**: ìš”ì²­ ë° ì‘ë‹µì„ ë¡œê¹…í•˜ê³  ëª¨ë‹ˆí„°ë§
- **ìš”ì²­ ë° ì‘ë‹µ ë³€í™˜**: ìš”ì²­ê³¼ ì‘ë‹µì„ ë³€í™˜í•˜ê±°ë‚˜ í•„í„°ë§

## 5.2 Spring Cloud Gateway ê°œìš”

### 5.2.1 Spring Cloud Gatewayë€?

- Spring Cloud GatewayëŠ” Spring í”„ë¡œì íŠ¸ì˜ ì¼í™˜ìœ¼ë¡œ ê°œë°œëœ API ê²Œì´íŠ¸ì›¨ì´ë¡œ, í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì ì ˆí•œ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ê³  ë‹¤ì–‘í•œ í•„í„°ë§ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
- Spring Cloud Netflix íŒ¨í‚¤ì§€ì˜ ì¼ë¶€ë¡œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ë„ë¦¬ ì‚¬ìš©ë©ë‹ˆë‹¤.

### 5.2.2 Spring Cloud Gatewayì˜ ì£¼ìš” íŠ¹ì§•

- **ë™ì  ë¼ìš°íŒ…**: ìš”ì²­ì˜ URL íŒ¨í„´ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë¼ìš°íŒ…
- **í•„í„°ë§**: ìš”ì²­ ì „í›„ì— ë‹¤ì–‘í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” í•„í„° ì²´ì¸ ì œê³µ
- **ëª¨ë‹ˆí„°ë§**: ìš”ì²­ ë¡œê·¸ ë° ë©”íŠ¸ë¦­ì„ í†µí•´ ì„œë¹„ìŠ¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§
- **ë³´ì•ˆ**: ìš”ì²­ì˜ ì¸ì¦ ë° ê¶Œí•œ ê²€ì¦

## 5.4 Spring Cloud Gateway í•„í„°ë§

### 5.4.1 í•„í„° ì¢…ë¥˜

- **Global Filter**: ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì‘ë™í•˜ëŠ” í•„í„°
- **Gateway Filter**: íŠ¹ì • ë¼ìš°íŠ¸ì—ë§Œ ì ìš©ë˜ëŠ” í•„í„°

### 5.4.2 í•„í„° êµ¬í˜„

- í•„í„°ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ `GlobalFilter` ë˜ëŠ” `GatewayFilter` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , `filter` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œí•´ì•¼ í•©ë‹ˆë‹¤.

### 5.4.3 í•„í„° ì£¼ìš” ê°ì²´

- Mono
    - `Mono`ëŠ” ë¦¬ì•¡í‹°ë¸Œ í”„ë¡œê·¸ë˜ë°ì—ì„œ 0 ë˜ëŠ” 1ê°œì˜ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    - `Mono<Void>`ëŠ” ì•„ë¬´ ë°ì´í„°ë„ ë°˜í™˜í•˜ì§€ ì•ŠìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
- ServerWebExchange
    - `ServerWebExchange`ëŠ” HTTP ìš”ì²­ê³¼ ì‘ë‹µì„ ìº¡ìŠí™”í•œ ê°ì²´ì…ë‹ˆë‹¤.
    - `exchange.getRequest()`ë¡œ HTTP ìš”ì²­ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - `exchange.getResponse()`ë¡œ HTTP ì‘ë‹µì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
- GatewayFilterChain
    - `GatewayFilterChain`ì€ ì—¬ëŸ¬ í•„í„°ë¥¼ ì²´ì¸ì²˜ëŸ¼ ì—°ê²°í•©ë‹ˆë‹¤.
    - `chain.filter(exchange)`ëŠ” ë‹¤ìŒ í•„í„°ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤.

### 5.4.4 í•„í„° ì‹œì ë³„ ì¢…ë¥˜

- Pre í•„í„°

  Pre í•„í„°ëŠ” ìš”ì²­ì´ ì²˜ë¦¬ë˜ê¸° ì „ì— ì‹¤í–‰ë©ë‹ˆë‹¤. ë”°ë¼ì„œ Pre í•„í„°ì—ì„œëŠ” ìš”ì²­ì„ ê°€ë¡œì±„ê³  í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•œ ë‹¤ìŒ, ì²´ì¸ì˜ ë‹¤ìŒ í•„í„°ë¡œ ìš”ì²­ì„ ì „ë‹¬í•©ë‹ˆë‹¤. ì´ë•Œ, ì¶”ê°€ì ì¸ ë¹„ë™ê¸° ì‘ì—…ì„ ìˆ˜í–‰í•  í•„ìš”ê°€ ì—†ê¸° ë•Œë¬¸ì— `then` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

    ```java
    @Component
    public class PreFilter implements GlobalFilter, Ordered {
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            // ìš”ì²­ ë¡œê¹…
            System.out.println("Request: " + exchange.getRequest().getPath());
            return chain.filter(exchange);
        }
    
        @Override
        public int getOrder() {  // í•„í„°ì˜ ìˆœì„œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
            return -1;  // í•„í„° ìˆœì„œë¥¼ ê°€ì¥ ë†’ì€ ìš°ì„  ìˆœìœ„ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        }
    }
    ```

- Post í•„í„°

  Post í•„í„°ëŠ” ìš”ì²­ì´ ì²˜ë¦¬ëœ í›„, ì‘ë‹µì´ ë°˜í™˜ë˜ê¸° ì „ì— ì‹¤í–‰ë©ë‹ˆë‹¤. Post í•„í„°ì—ì„œëŠ” ì²´ì¸ì˜ ë‹¤ìŒ í•„í„°ê°€ ì™„ë£Œëœ í›„ì— ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì¶”ê°€ì ì¸ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ `chain.filter(exchange)`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ í•„í„°ë¥¼ ì‹¤í–‰í•œ í›„, `then` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µì´ ì™„ë£Œëœ í›„ì— ì‹¤í–‰í•  ì‘ì—…ì„ ì •ì˜í•©ë‹ˆë‹¤.

    ```java
    @Component
    public class PostFilter implements GlobalFilter, Ordered {
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            return chain.filter(exchange).then(Mono.fromRunnable(() -> {
                // ì‘ë‹µ ë¡œê¹…
                System.out.println("Response Status: " + exchange.getResponse().getStatusCode());
            }));
        }
    
        @Override
        public int getOrder() {
            return -1;
        }
    }
    ```


## 5.5 Spring Cloudì™€ì˜ í†µí•©

### 5.5.1 Spring Cloudì™€ì˜ í†µí•©

- Spring Cloud GatewayëŠ” Spring Cloud Netflix íŒ¨í‚¤ì§€ì˜ ì¼ë¶€ë¡œ, Eurekaì™€ ì‰½ê²Œ í†µí•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- Eurekaë¥¼ í†µí•´ ë™ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒí•˜ì—¬ ë¡œë“œ ë°¸ëŸ°ì‹±ê³¼ ë¼ìš°íŒ…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 5.6 ì‹¤ìŠµ

> ğŸ’¡ í´ë¼ìš°ë“œ ê²Œì´íŠ¸ì›¨ì´ + ìœ ë ˆì¹´ + Order ì¸ìŠ¤í„´ìŠ¤(1ê°œ) + Product ì¸ìŠ¤í„´ìŠ¤(2ê°œ) ë¡œ ì§„í–‰í•´ë´…ë‹ˆë‹¤.

![API GW](https://teamsparta.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F83c75a39-3aba-4ba4-a792-7aefe4b07895%2F6d07e933-f3a0-4a71-83e5-63c8ef4558c8%2FUntitled.png?table=block&id=b1289a79-3949-40ff-b3f3-d74c73e58fe7&spaceId=83c75a39-3aba-4ba4-a792-7aefe4b07895&width=770&userId=&cache=v2)

> order, product ë¶€ë¶„ì€ ì „ì— ì‚¬ìš©í•˜ì˜€ë˜ ë¡œë“œë°¸ëŸ°ì‹± íŒ¨í‚¤ì§€ì—ì„œ í¬íŠ¸ë²ˆí˜¸ë§Œ ë°”ê¾¸ì–´ ì¤ë‹ˆë‹¤.

### 5.6.1 ê²Œì´íŠ¸ ì›¨ì´

- [start.spring.io](http://start.spring.io) ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ë””íœë˜ì‹œë¥¼ ì¶”ê°€ í›„ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

  ![spring.io](https://github.com/user-attachments/assets/07775d75-57b0-49d6-bf5b-ef784fb37d25)

- CustomPreFilter.java

    ```java
    import org.springframework.cloud.gateway.filter.GatewayFilterChain;
    import org.springframework.cloud.gateway.filter.GlobalFilter;
    import org.springframework.core.Ordered;
    import org.springframework.http.server.reactive.ServerHttpRequest;
    import org.springframework.stereotype.Component;
    import org.springframework.web.server.ServerWebExchange;
    import reactor.core.publisher.Mono;
    
    import java.util.logging.Logger;
    
    @Component
    public class CustomPreFilter implements GlobalFilter, Ordered {
    
        private static final Logger logger = Logger.getLogger(CustomPreFilter.class.getName());
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            ServerHttpRequest response = exchange.getRequest();
            logger.info("Pre Filter: Request URI is " + response.getURI());
            // Add any custom logic here
    
            return chain.filter(exchange);
        }
    
        @Override
        public int getOrder() {
            return Ordered.HIGHEST_PRECEDENCE;
        }
    }
    ```

- CustomPostFilter.java

    ```java
    import org.springframework.cloud.gateway.filter.GlobalFilter;
    import org.springframework.core.Ordered;
    import org.springframework.http.server.reactive.ServerHttpResponse;
    import org.springframework.stereotype.Component;
    import org.springframework.web.server.ServerWebExchange;
    import reactor.core.publisher.Mono;
    
    import java.util.logging.Logger;
    
    @Component
    public class CustomPostFilter implements GlobalFilter, Ordered {
    
        private static final Logger logger = Logger.getLogger(CustomPostFilter.class.getName());
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, org.springframework.cloud.gateway.filter.GatewayFilterChain chain) {
            return chain.filter(exchange).then(Mono.fromRunnable(() -> {
                ServerHttpResponse response = exchange.getResponse();
                logger.info("Post Filter: Response status code is " + response.getStatusCode());
                // Add any custom logic here
            }));
        }
    
        @Override
        public int getOrder() {
            return Ordered.LOWEST_PRECEDENCE;
        }
    }
    ```

- application.yml

    ```yaml
    server:
      port: 19091  # ê²Œì´íŠ¸ì›¨ì´ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  í¬íŠ¸ ë²ˆí˜¸
    
    spring:
      main:
        web-application-type: reactive  # Spring ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¦¬ì•¡í‹°ë¸Œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì„¤ì •ë¨
      application:
        name: gateway-service  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ì„ 'gateway-service'ë¡œ ì„¤ì •
      cloud:
        gateway:
          routes:  # Spring Cloud Gatewayì˜ ë¼ìš°íŒ… ì„¤ì •
            - id: order-service  # ë¼ìš°íŠ¸ ì‹ë³„ì
              uri: lb://order-service  # 'order-service'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ëœ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…
              predicates:
                - Path=/order/**  # /order/** ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì´ ë¼ìš°íŠ¸ë¡œ ì²˜ë¦¬
            - id: product-service  # ë¼ìš°íŠ¸ ì‹ë³„ì
              uri: lb://product-service  # 'product-service'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ëœ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…
              predicates:
                - Path=/product/**  # /product/** ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ì´ ë¼ìš°íŠ¸ë¡œ ì²˜ë¦¬
          discovery:
            locator:
              enabled: true  # ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ í†µí•´ ë™ì ìœ¼ë¡œ ë¼ìš°íŠ¸ë¥¼ ìƒì„±í•˜ë„ë¡ ì„¤ì •
    
    eureka:
      client:
        service-url:
          defaultZone: http://localhost:19090/eureka/  # Eureka ì„œë²„ì˜ URLì„ ì§€ì •
    ```


### 6.7.5 Run

- ìœ ë ˆì¹´ ì„œë²„ â‡’ ê²Œì´íŠ¸ì›¨ì´ â‡’ ì£¼ë¬¸ â‡’ ìƒí’ˆ ìˆœìœ¼ë¡œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
- [http://localhost:19090](http://localhost:19090/)ì— ì ‘ì†í•˜ì—¬ ê° ì¸ìŠ¤í„´ìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

  ![19090](https://github.com/user-attachments/assets/08af392a-f0e8-4738-8462-6c37adcdab98)

- http://localhost:19091/order ë¡œ ì ‘ì†í•˜ì—¬ ê²Œì´íŠ¸ì›¨ì´ì—ì„œ order ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ![order](https://github.com/user-attachments/assets/98023d8a-be19-4c4c-868b-4baf45e051ff)

- http://localhost:19091/product ë¥¼ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œ í•˜ë©´ì„œ í¬íŠ¸ê°€ ë‹¬ë¼ì§€ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤. ì´ë¥¼í†µí•´ ë¡œë“œë°¸ëŸ°ì‹±ì´ ë™ì‘í•¨ì„ í™•ì¸í•©ë‹ˆë‹¤.

  ![product1](https://github.com/user-attachments/assets/2f46f2fa-3bc9-4caf-821a-9bbbd473aa25)

  ![product2](https://github.com/user-attachments/assets/1b5f9bfa-7d29-4852-ac1a-ef5b8a2d9be3)

- ê²Œì´íŠ¸ì›¨ì´ì˜ ë¡œê·¸ë¥¼ ë³´ë©´ í˜¸ì¶œ í• ë•Œë§ˆë‹¤ í•„í„°ê°€ ë™ì‘í•˜ëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ![GW log](https://github.com/user-attachments/assets/088119ee-50f5-4bb6-b156-b2088999879c)
